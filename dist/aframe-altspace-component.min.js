!function(e){"use strict";function t(e){var n={};return n=e.__proto__?Object.assign(t(e.__proto__),e):Object.assign({schema:{},dependencies:[]},e),e.schema&&Object.assign(n.schema,e.schema),e.dependencies&&(i=n.dependencies).push.apply(i,e.dependencies),n;var i}function n(e,n){AFRAME.registerComponent(e,t(new n(!0)))}function i(e,n){AFRAME.registerSystem(e,t(new n(!0)))}function a(e,t,n){return 0===t.length?n:(e[t[0]]=a(e[t[0]]||{},t.slice(1),n),e)}var o=function(){},s={schema:{}};s.schema.get=function(){return null},o.prototype.init=function(){},o.prototype.tick=function(e,t){},o.prototype.pause=function(){},o.prototype.play=function(){},Object.defineProperties(o.prototype,s);var r=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(e){},t.prototype.remove=function(){},t.prototype.updateSchema=function(e){},t}(o),c=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={schema:{}};return n.schema.get=function(){return{enabled:{type:"boolean",default:"true"}}},t.prototype.init=function(){var e=this;this.setColliderFlag(this.data.enabled),this.el.addEventListener("model-loaded",function(){e.setColliderFlag(e.data.enabled)}.bind(this))},t.prototype.update=function(){this.setColliderFlag(this.data.enabled)},t.prototype.setColliderFlag=function(e){var t=this.el.object3D;t&&(console.log("Setting collider flag to",e),a(t.userData,["altspace","collider","enabled"],e),t.traverse(function(t){t instanceof THREE.Mesh&&a(t.userData,["altspace","collider","enabled"],e)}))},Object.defineProperties(t.prototype,n),t}(r),l=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(){this.gamepadIndex=null,this.trackedControlsSystem=document.querySelector("a-scene").systems["tracked-controls"],this.systemGamepads=0,altspace.getGamepads()},t.prototype.tick=function(){if(this.trackedControlsSystem&&this.systemGamepads!==this.trackedControlsSystem.controllers.length&&window.altspace&&altspace.getGamepads&&altspace.getGamepads().length){var e=this.el.components;e["paint-controls"]&&(this.gamepadIndex="left"===e["paint-controls"].data.hand?2:1),null===this.gamepadIndex&&e["hand-controls"]&&(this.gamepadIndex="left"===e["hand-controls"].data?2:1),null===this.gamepadIndex&&e["vive-controls"]&&(this.gamepadIndex="left"===e["vive-controls"].data.hand?2:1),null===this.gamepadIndex&&e["tracked-controls"]&&(this.gamepadIndex=e["tracked-controls"].data.controller),this.el.setAttribute("tracked-controls","id",altspace.getGamepads()[this.gamepadIndex].id),this.el.setAttribute("tracked-controls","controller",0),this.systemGamepads=this.trackedControlsSystem.controllers.length}},t}(r),d=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={schema:{}};return n.schema.get=function(){return{usePixelScale:{type:"boolean",default:"false"},verticalAlign:{type:"string",default:"middle"},enclosuresOnly:{type:"boolean",default:"true"},fullspace:{type:"boolean",default:"false"}}},t.prototype.init=function(){return this.version="AFRAME_ALTSPACE_VERSION",!this.el.object3D instanceof THREE.Scene?void console.warn("aframe-altspace-component can only be attached to a-scene"):void(window.altspace&&window.altspace.inClient?(this.el.setAttribute("vr-mode-ui",{enabled:!1}),this.initRenderer(),this.initCursorEvents(),this.initCollisionEvents()):console.warn("aframe-altspace-component only works inside of AltspaceVR"))},t.prototype.tick=function(e,t){this.el.object3D.updateAllBehaviors&&this.el.object3D.updateAllBehaviors()},t.prototype.initRenderer=function(){var e=this,t=this.el.object3D;altspace.getEnclosure().then(function(i){switch(e.data.fullspace&&(i.requestFullspace(),i.addEventListener("fullspacechange",function(){t.scale.setScalar(i.pixelsPerMeter)})),e.data.usePixelScale&&!e.data.fullspace||t.scale.setScalar(i.pixelsPerMeter),e.data.verticalAlign){case"bottom":t.position.y-=i.innerHeight/2;break;case"top":t.position.y+=i.innerHeight/2;break;case"middle":break;default:console.warn("Unexpected value for verticalAlign: ",e.data.verticalAlign)}e.data.enclosuresOnly&&1===i.innerDepth&&(e.el.renderer.render(new THREE.Scene),e.el.renderer=e.el.effect=n)}.bind(this));var n=this.el.renderer,i=this.el.renderer=this.el.effect=altspace.getThreeJSRenderer({aframeComponentVersion:this.version}),a=function(){};i.setSize=a,i.setPixelRatio=a,i.setClearColor=a,i.clear=a,i.enableScissorTest=a,i.setScissor=a,i.setViewport=a,i.getPixelRatio=a,i.getMaxAnisotropy=a,i.setFaceCulling=a,i.context={canvas:{}},i.shadowMap={}},t.prototype.initCursorEvents=function(){function e(e,t){var i=t.target.el;n&&n.emit(e,{target:i,ray:t.ray,point:t.point}),i&&i.emit(e,{target:i,ray:t.ray,point:t.point})}var t=this.el.object3D,n=document.querySelector("a-cursor")||document.querySelector("a-entity[cursor]");n&&(n.setAttribute("material","transparent",!0),n.setAttribute("material","opacity",0));var i=null;t.addEventListener("cursordown",function(t){i=t.target,e("mousedown",t)}),t.addEventListener("cursorup",function(t){e("mouseup",t),t.target.uuid===i.uuid&&e("click",t),i=null}),t.addEventListener("cursorenter",function(t){t.target.el&&(t.target.el.addState("hovered"),n&&n.addState("hovering"),e("mouseenter",t))}),t.addEventListener("cursorleave",function(t){t.target.el&&(t.target.el.removeState("hovered"),n&&n.removeState("hovering"),e("mouseleave",t))})},t.prototype.initCollisionEvents=function(){function e(e,t){var n=t.target.el;n&&(t.target=n,t.other&&t.other.el&&(t.other=t.other.el),n.emit(e,t))}var t=this.el.object3D;t.addEventListener("collisionenter",function(t){e("collisionenter",t)}),t.addEventListener("collisionexit",function(t){e("collisionexit",t)}),t.addEventListener("triggerenter",function(t){e("triggerenter",t)}),t.addEventListener("triggerexit",function(t){e("triggerexit",t)})},Object.defineProperties(t.prototype,n),t}(r),p=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={dependencies:{}};return n.dependencies.get=function(){return["sync"]},t.prototype.init=function(){function e(){var e=n.dataRef.child("material/color"),i=!1,a=!0;t.el.addEventListener("componentchanged",function(t){var a=t.detail.name,o=t.detail.oldData,s=t.detail.newData;"material"===a&&!i&&o.color!==s.color&&n.isMine&&setTimeout(function(){return e.set(s.color)},0)}),e.on("value",function(e){if(!n.isMine||a){var o=e.val();i=!0,t.el.setAttribute("material","color",o),i=!1,a=!1}})}var t=this,n=t.el.components.sync;n.isConnected?e():t.el.addEventListener("connected",e)},Object.defineProperties(t.prototype,n),t}(r),u=function(e){function t(e){void 0===e&&(e=!1),this._isComponent=e,this.scene=void 0,this.syncSys=void 0,this.ref=void 0,this.key=void 0,this.dataRef=void 0,this.ownerRef=void 0,this.ownerId=void 0,this.isConnected=!1,this.isMine=!1}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={schema:{}};return n.schema.get=function(){return{mode:{default:"link"},ownOn:{type:"string"}}},t.prototype.init=function(){var e=this;if(this.scene=this.el.sceneEl,this.syncSys=this.scene.systems["sync-system"],this.syncSys.isConnected?start():this.scene.addEventListener("connected",this.start.bind(this)),this.data.ownOn){var t=this.data.ownOn.split(/[ ,]+/);t.forEach(function(t){e.el.addEventListener(t,function(){e.isConnected&&e.takeOwnership()}.bind(e))}.bind(this))}},t.prototype.takeOwnership=function(){this.ownerRef.set(this.syncSys.clientId),this.ownerRef.onDisconnect().set(null)},t.prototype.start=function(){var e=this;if(this.scene.addEventListener("clientleft",function(t){var n=(!ownerId||ownerId===t.detail.id)&&e.syncSys.isMasterClient;n&&e.takeOwnership()}.bind(this)),"link"!==this.data.mode)return void console.error("Unsupported sync mode: "+this.data.mode);var t=this.el.id;return t?(console.log("syncSys: "+this.syncSys),console.log("syncSys.sceneRef: "+this.syncSys.sceneRef),this.link(this.syncSys.sceneRef.child(t)),this.setupReceive(),this.isConnected=!0,void this.el.emit("connected",null,!1)):void console.error("Entities cannot be synced using link mode without an id.")},t.prototype.link=function(e){this.ref=e,this.key=this.ref.key(),this.dataRef=this.ref.child("data"),this.ownerRef=this.ref.child("owner")},t.prototype.setupReceive=function(){var e=this;this.ownerRef.transaction(function(t){if(!t)return e.ownerRef.onDisconnect().set(null),e.syncSys.clientId}.bind(this)),this.ownerRef.on("value",function(t){var n=t.val(),i=n===e.syncSys.clientId&&!e.isMine;i&&e.el.emit("ownershipgained",null,!1);var a=n!==e.syncSys.clientId&&e.isMine;a&&(e.el.emit("ownershiplost",null,!1),e.ownerRef.onDisconnect().cancel()),e.ownerId=n,e.isMine=n===e.syncSys.clientId}.bind(this))},Object.defineProperties(t.prototype,n),t}(r),h=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={schema:{}};return n.schema.get=function(){return{author:{type:"string",default:null},app:{type:"string",default:null},instance:{type:"string",default:null},refUrl:{type:"string",default:null}}},t.prototype.init=function(){return this.data&&this.data.app?(console.log(this.data),this.isConnected=!1,void altspace.utilities.sync.connect({authorId:this.data.author,appId:this.data.app,instanceId:this.data.instance,baseRefUrl:this.data.refUrl}).then(this.connected.bind(this))):void console.warn("The sync-system must be present on the scene and configured with required data.")},t.prototype.connected=function(e){this.connection=e,this.sceneRef=this.connection.instance.child("scene"),this.clientsRef=this.connection.instance.child("clients"),this.clientId=this.sceneEl.object3D.uuid,this.masterClientId=null;var t=this;this.clientsRef.on("value",function(e){var n=e.val(),i=Object.keys(n)[0];t.masterClientId=n[i]}),this.clientsRef.on("child_added",function(e){var n=e.val();setTimeout(function(){t.sceneEl.emit("clientjoined",{id:n},!1)},0)}),this.clientsRef.on("child_removed",function(e){var n=e.val();setTimeout(function(){t.sceneEl.emit("clientleft",{id:n},!1)},0)}),this.clientsRef.push(this.clientId).onDisconnect().remove(),this.connection.instance.child("initialized").once("value",function(e){var n=!e.val();e.ref().set(!0),t.sceneEl.emit("connected",{shouldInitialize:n},!1),t.isConnected=!0})},t.prototype.isMasterClient=function(){return this.masterClientId===this.clientId},Object.defineProperties(t.prototype,n),t}(o);AFRAME.registerComponent("sync-transform",{dependencies:["sync"],schema:{},init:function(){function e(){function e(e,i){if(!n.isMine){var a=e.val();a&&t.el.setAttribute(i,a)}}function i(e){if(n.isMine){var t=e.detail.name,i=e.detail.newData;if("position"===t)l(i);else if("rotation"===t)d(i);else{if("scale"!==t)return;p(i)}}}function a(e,t,n){var i,a,o,s,r=0;n||(n={});var c=function(){r=n.leading===!1?0:Date.now(),i=null,s=e.apply(a,o),i||(a=o=null)},l=function(){var l=Date.now();r||n.leading!==!1||(r=l);var d=t-(l-r);return a=this,o=arguments,d<=0||d>t?(i&&(clearTimeout(i),i=null),r=l,s=e.apply(a,o),i||(a=o=null)):i||n.trailing===!1||(i=setTimeout(c,d)),s};return l.cancel=function(){clearTimeout(i),r=0,i=a=o=null},l}var o=n.dataRef.child("position"),s=n.dataRef.child("rotation"),r=n.dataRef.child("scale");t.updateRate=100;var c=[];t.el.addEventListener("ownershiplost",function(){for(var e=t.el.children,n=0;n<e.length;n++){var i=e[n].tagName.toLowerCase();"a-animation"===i&&(c.push(e[n]),e[n].stop())}}),t.el.addEventListener("ownershipgained",function(){for(var e=0;e<c.length;e++){var t=c[e];t.start()}c=[]}),o.on("value",function(t){e(t,"position")}),s.on("value",function(t){e(t,"rotation")}),r.on("value",function(t){e(t,"scale")});var l=a(function(e){o.set(e)},t.updateRate),d=a(function(e){s.set(e)},t.updateRate),p=a(function(e){r.set(e)},t.updateRate);t.el.addEventListener("componentchanged",i)}var t=this,n=t.el.components.sync;n.isConnected?e():t.el.addEventListener("connected",e)}});(function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={dependencies:{}};return n.dependencies.get=function(){return["sync"]},Object.defineProperties(t.prototype,n),t})(r);if(AFRAME.registerComponent("sync-n-sound",{dependencies:["sync"],schema:{},init:function(){function e(){function e(e){if(n.isMine){var e={type:e.type,sender:a.clientId,el:t.el.id,time:Date.now()};t.soundEventRef.set(e)}}t.soundStateRef=n.dataRef.child("sound/state"),t.soundEventRef=n.dataRef.child("sound/event"),t.el.addEventListener("sound-played",e),t.el.addEventListener("sound-paused",e),t.soundEventRef.on("value",function(e){if(!n.isMine){var i=e.val();if(i&&i.el===t.el.id){var a=t.el.components["n-sound"];"sound-played"===i.type?a.playSound():a.pauseSound()}}}),t.el.addEventListener("componentchanged",function(e){if(n.isMine){var i=e.detail.name;"n-sound"===i&&t.soundStateRef.set(e.detail.newData)}}),t.soundStateRef.on("value",function(e){if(!n.isMine){var i=e.val();i&&t.el.setAttribute("n-sound",i)}})}var t=this,n=t.el.components.sync,i=document.querySelector("a-scene"),a=i.systems["sync-system"];n.isConnected?e():t.el.addEventListener("connected",e)},remove:function(){this.soundStateRef.off("value"),this.soundEventRef.off("value")}}),function(){function e(e){e.userData.altspace=e.userData.altspace||{},e.userData.altspace.collider=e.userData.altspace.collider||{},e.userData.altspace.collider.enabled=!1,altspace.addNativeComponent(e,this.name)}function t(){var t=this.el.getOrCreateObject3D("mesh",c);e.call(this,t),this.update(this.data)}function n(){var e=this.el.getObject3D("mesh");altspace.removeNativeComponent(e,this.name)}function i(e){altspace.updateNativeComponent(this.el.object3DMap.mesh,this.name,this.data)}function a(e,t){altspace.callNativeComponent(this.el.object3DMap.mesh,this.name,e,t)}if(!window.altspace||!altspace.inClient){var o=function(){};window.altspace={addNativeComponent:o,updateNativeComponent:o,removeNativeComponent:o}}var s=new THREE.BoxGeometry(.001,.001,.001),r=new THREE.MeshBasicMaterial({color:0});r.visible=!1;var c=function(){THREE.Mesh.call(this,s,r)};c.prototype=Object.create(THREE.Mesh.prototype),c.prototype.constructor=THREE.PlaceholderMesh,AFRAME.registerComponent("n-object",{schema:{res:{type:"string"}},init:t,update:i,remove:n}),AFRAME.registerComponent("n-spawner",{schema:{res:{type:"string"}},init:t,update:i,remove:n}),AFRAME.registerComponent("n-text",{init:t,update:i,remove:n,schema:{text:{default:"",type:"string"},fontSize:{default:"10",type:"int"},width:{default:"10",type:"number"},height:{default:"1",type:"number"},horizontalAlign:{default:"middle"},verticalAlign:{default:"middle"}}}),AFRAME.registerComponent("n-sphere-collider",{init:t,remove:n,update:i,schema:{isTrigger:{default:!1,type:"boolean"},center:{type:"vec3"},radius:{default:"0",type:"number"},type:{default:"object"}}}),AFRAME.registerComponent("n-box-collider",{init:t,remove:n,update:i,schema:{isTrigger:{default:!1,type:"boolean"},center:{type:"vec3"},size:{type:"vec3"},type:{default:"object"}}}),AFRAME.registerComponent("n-capsule-collider",{init:t,remove:n,update:i,schema:{isTrigger:{default:!1,type:"boolean"},center:{type:"vec3"},radius:{default:"0",type:"number"},height:{default:"0",type:"number"},direction:{default:"y"},type:{default:"object"}}}),AFRAME.registerComponent("n-mesh-collider",{_forEachMesh:function(e){var t=this.el.object3DMap.mesh;t&&(t instanceof THREE.Mesh&&e(t),t.traverse(function(t){t instanceof THREE.Mesh&&e(t)}.bind(this)))},_initObj:function(){this._forEachMesh(function(t){e.call(this,t),altspace.updateNativeComponent(t,this.name,this.data)}.bind(this))},init:function(){this.el.getOrCreateObject3D("mesh",c),this._initObj(),this.el.addEventListener("model-loaded",function(){this._initObj()}.bind(this))},remove:function(){this._forEachMesh(function(e){altspace.removeNativeComponent(e,this.name)}.bind(this))},update:function(e){this._forEachMesh(function(e){altspace.updateNativeComponent(e,this.name,this.data)}.bind(this))},schema:{isTrigger:{default:!1,type:"boolean"},convex:{default:!0,type:"boolean"},type:{default:"object"}}}),AFRAME.registerComponent("n-billboard",{init:t,remove:n}),AFRAME.registerComponent("n-container",{init:function(){t.call(this);var e=this.el,n=this;e.addEventListener("stateadded",function(t){"container-full"===t.detail.state&&e.emit("container-full"),"container-empty"===t.detail.state&&e.emit("container-empty")}),e.addEventListener("container-count-changed",function(e){n.count=e.detail.count})},remove:n,update:i,schema:{capacity:{default:4,type:"number"}}}),AFRAME.registerComponent("n-sound",{init:function(){var e=this.data.src;if(e&&!e.startsWith("http"))if(e.startsWith("/"))this.data.src=location.origin+e;else{var n=location.pathname;n.endsWith("/")||(n=location.pathname.split("/").slice(0,-1).join("/")+"/"),this.data.src=location.origin+n+e}t.call(this)},pauseSound:function(){a.call(this,"pause"),this.el.emit("sound-paused")},playSound:function(){a.call(this,"play"),this.el.emit("sound-played")},seek:function(e){a.call(this,"seek",{time:e})},remove:function(){n.call(this),this.playHandler&&this.el.removeEventListener(oldData.on,this.playHandler)},update:function(e){i.call(this,e),this.playHandler&&this.el.removeEventListener(e.on,this.playHandler),this.data.on&&(this.playHandler=this.playSound.bind(this),this.el.addEventListener(this.data.on,this.playHandler))},schema:{on:{type:"string"},res:{type:"string"},src:{type:"string"},loop:{type:"boolean"},volume:{type:"number",default:1},autoplay:{type:"boolean"},oneshot:{type:"boolean"},spatialBlend:{type:"float",default:1},pitch:{type:"float",default:1},minDistance:{type:"float",default:1},maxDistance:{type:"float",default:12},rolloff:{type:"string",default:"logarithmic"}}})}(),AFRAME.registerComponent("wire",{multiple:!0,schema:{on:{type:"string"},emit:{type:"string"},gained:{type:"string"},lost:{type:"string"},gain:{type:"string"},lose:{type:"string"},targets:{type:"selectorAll"},target:{type:"selector"}},update:function(e){e.on&&this.el.removeEventListener(e.on,this.actOnTargets),e.gained&&this.el.removeEventListener("stateadded",this.actOnTargetsIfStateMatches),e.lost&&this.el.removeEventListener("stateremoved",this.actOnTargetsIfStateMatches),this.actOnTargets=function(){function e(e){this.data.emit&&e.emit(this.data.emit),this.data.gain&&e.addState(this.data.gain),this.data.lose&&e.removeState(this.data.lose)}this.data.targets&&this.data.targets.forEach(e.bind(this)),this.data.target&&e.call(this,this.data.target)}.bind(this),this.actOnTargetsIfStateMatches=function(e){var t=e.detail.state;t!==this.data.gained&&t!==this.data.lost||this.actOnTargets()}.bind(this),this.data.on&&this.el.addEventListener(this.data.on,this.actOnTargets),this.data.gained&&this.el.addEventListener("stateadded",this.actOnTargetsIfStateMatches),this.data.lost&&this.el.addEventListener("stateremoved",this.actOnTargetsIfStateMatches)},remove:function(){this.el.removeEventListener(this.data.on,this.actOnTargets),this.el.removeEventListener("stateadded",this.actOnTargetsIfStateMatches),this.el.removeEventListener("stateremoved",this.actOnTargetsIfStateMatches)}}),"undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");n("altspace-cursor-collider",c),n("altspace-tracked-controls",l),n("altspace",d),n("sync-color",p),n("sync",u),i("sync-system",h),e.AltspaceComponent=d,e.AltspaceCursorCollider=c,e.AltspaceTrackedControls=l,e.SyncSystem=h,e.SyncComponent=u,e.SyncColor=p,e.flatten=t}(this.ALTSPACE=this.ALTSPACE||{});
//# sourceMappingURL=aframe-altspace-component.min.js.map
