<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>threebase.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="utilities.ColorHoverEffect.html">ColorHoverEffect</a><ul class='methods'><li data-type='method'><a href="utilities.ColorHoverEffect.html#add">add</a></li><li data-type='method'><a href="utilities.ColorHoverEffect.html#init">init</a></li></ul></li><li><a href="utilities.DragPlaneEffect.html">DragPlaneEffect</a><ul class='methods'><li data-type='method'><a href="utilities.DragPlaneEffect.html#add">add</a></li><li data-type='method'><a href="utilities.DragPlaneEffect.html#init">init</a></li></ul></li><li><a href="multiloader.LoadRequest.html">LoadRequest</a><ul class='methods'><li data-type='method'><a href="multiloader.LoadRequest.html#error">error</a></li><li data-type='method'><a href="multiloader.LoadRequest.html#mtlUrls">mtlUrls</a></li><li data-type='method'><a href="multiloader.LoadRequest.html#objects">objects</a></li><li data-type='method'><a href="multiloader.LoadRequest.html#objectsLoaded">objectsLoaded</a></li><li data-type='method'><a href="multiloader.LoadRequest.html#objUrls">objUrls</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="multiloader.html">altspace/utilities/multiloader</a><ul class='methods'><li data-type='method'><a href="multiloader.html#init">init</a></li><li data-type='method'><a href="multiloader.html#load">load</a></li></ul></li><li><a href="bubbling.html">altspace/utilities/shims/bubbling</a></li><li><a href="cursor.html">altspace/utilities/shims/cursor</a><ul class='methods'><li data-type='method'><a href="cursor.html#init">init</a></li></ul></li><li><a href="dualRenderer.html">altspace/utilities/shims/dualRenderer</a><ul class='methods'><li data-type='method'><a href="dualRenderer.html#ambientLight">ambientLight</a></li><li data-type='method'><a href="dualRenderer.html#camera">camera</a></li><li data-type='method'><a href="dualRenderer.html#inAltMode">inAltMode</a></li><li data-type='method'><a href="dualRenderer.html#renderer">renderer</a></li><li data-type='method'><a href="dualRenderer.html#init">init</a></li><li data-type='method'><a href="dualRenderer.html#render">render</a></li></ul></li><li><a href="threebase.html">altspace/utilities/threebase</a><ul class='methods'><li data-type='method'><a href="threebase.html#add">add</a></li><li data-type='method'><a href="threebase.html#init">init</a></li><li data-type='method'><a href="threebase.html#save">save</a></li><li data-type='method'><a href="threebase.html#update">update</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">threebase.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Synchronize position/rotation of distributed Three.js objects using Firebase.
 * @module altspace/utilities/threebase
 */
altspace = window.altspace || {};
altspace.utilities = altspace.utilities || {};
altspace.utilities.threebase = (function(){

	var syncInstance;
	var TRACE;

	var keyForLocalUuid = {};
	var objectInfoForKey = {};
	var DEFAULT_SYNC_EVERY = 100;
	var PRECISION_DIGITS = 2;

	function init(mySyncInstance, params){
		syncInstance = mySyncInstance;
		var p = params || {};
		TRACE = p.TRACE || false;
	}

	function add(object3d, params){
		validateAdd(object3d, params);
		var key = object3d.name;
		if (TRACE) console.log('threebase: adding object ' + key, object3d)
		objectInfo = {
			object: object3d,
			key: key,
			params: params,
			lastSaveAt: null,
			lastSaveData: null,
			lastSyncAt: null,
		};
		objectInfoForKey[key] = objectInfo;
		keyForLocalUuid[object3d.uuid] = key;
		syncInstance.child(key).on('value', function(snapshot){
			var data = snapshot.val();
			var key = snapshot.key();
			var objectInfo = objectInfoForKey[key];
			if (data){
				validateData(key, data);
				if (TRACE) console.log('threebase: SYNC data for ' + key, data);
				var target = objectInfoForKey[key].object;
				if (data.position){
					target.position.set(data.position.x, data.position.y, data.position.z);
				}
				if (data.rotation){
					target.rotation.set(data.rotation.x, data.rotation.y, data.rotation.z);
				}
				objectInfo.lastSyncAt = Date.now();
			} else {
				save(objectInfo.object);//We are first to create this object, save it.
			}
		});
	}

	function save(object3d){
		validateSave(object3d);
		var key = keyForLocalUuid[object3d.uuid];
		var objectInfo = objectInfoForKey[key];
		var p = objectInfo.params || {};
		var savePosition = p.position === undefined || p.position;
		var saveRotation = p.rotation === undefined || p.rotation;
		var data = {};
		if (savePosition) data.position = {
			'x': object3d.position.x,
			'y': object3d.position.y,
			'z': object3d.position.z,
		};
		if (saveRotation) data.rotation = {
			'x': object3d.rotation.x,
			'y': object3d.rotation.y,
			'z': object3d.rotation.z,
		};
		//Only save if values have changes since last save.
		if (dataDiffers(objectInfo.lastSaveData, data)){
			objectInfo.lastSaveData = data;
			objectInfo.lastSaveAt = Date.now();
			if (TRACE) console.log('threebase: SAVE data for ' + key, data);
			syncInstance.child(key).set(data, function(error){
				if (error){
					console.error('threebase: SAVE failed', error);
				}
			});
		}
	}

	function update(){
		var keys = Object.keys(objectInfoForKey);
		for(var i=0; i &lt; keys.length; i++){
			var objectInfo = objectInfoForKey[keys[i]];
			if (!objectInfo.lastSyncAt){
				continue;//Wait until initial sync before updating.
			}
			var lastSaveAt = objectInfo.lastSaveAt;
			var p = objectInfo.p || {};
			var autoSyncEvery = p.autoSyncEvery || DEFAULT_SYNC_EVERY;
			if (lastSaveAt &amp;&amp; (Date.now() - lastSaveAt &lt; autoSyncEvery)){
				continue;//Wait until per-object interval has elapsed.
			}	
			save(objectInfo.object);	
		}
	}

	function dataDiffers(data1, data2){
		var roundXYZ = function(triple){
			triple.x = Number(triple.x.toFixed(PRECISION_DIGITS));	
			triple.y = Number(triple.y.toFixed(PRECISION_DIGITS));	
			triple.z = Number(triple.z.toFixed(PRECISION_DIGITS));	
			return triple;
		};
		var diffXYZ = function(triple1, triple2){
			var t1 = roundXYZ(triple1);
			var t2 = roundXYZ(triple2);
			return t1.x !== t2.x || t1.y !== t2.y || t1.z !== t2.z;
		};
		if (!data1){
			return true;
		}
		var diffPosition = data1.position &amp;&amp; diffXYZ(data1.position, data2.position);
		var diffRotation = data1.rotation &amp;&amp; diffXYZ(data1.rotation, data2.rotation);
		return diffPosition || diffRotation;
	}

	//LOTS of validation, since errors in callbacks are really hard to track down.

	function validateAdd(object3d, params){
		var key = object3d.name;
		if (!syncInstance){
			die('threebase: must init() before adding objects');
		}
		if (!object3d instanceof THREE.Object3D){
			die('threebase: cannot add, not a THREE.Object3d', object3d);
		}
		if (!key){
			die('threebase: object.name must be set to a unique key for object', object3d);
		}
		if (objectInfoForKey[key]){
			die('threebase: key (object.name) '+ key +' already in use for another object');
		}
		if (params){
		    if (typeof(params) !== 'object'){
				die('threebase: params passed to add is not an object', params);
			}
			if (params.position &amp;&amp; typeof(params.position) !== 'boolean'){
				die('threebase: params[\'position\'] is not a boolean', params.position);
			}
			if (params.rotation &amp;&amp; typeof(params.rotation) !== 'boolean'){
				die('threebase: params[\'rotation\'] is not a boolean', params.rotation);
			}
			if (params.autoSyncEvery){
				var ase = params.autoSyncEvery;
				if (typeof(ase) !== 'number'){
					die('threebase: params[\'autoSyncEvery\'] is not a number', ase);
				}
				if (ase &lt; 0 ){
					die('threebase: params[\'autoSyncEvery\'] cannot be negative', ase);
				}
			}
		}
	}

	function validateSave(object3d){
		if (!object3d instanceof THREE.Object3D){
			die('threebase: cannot save, not a THREE.Object3d', object3d);
		}
		if (!keyForLocalUuid[object3d.uuid]){
			die('threebase: cannot save, object not yet added locally', object3d);
		}
	}

	function validateData(key, data){
		var position = data.position;
		var rotation = data.rotation;
		if (typeof(key) !== 'string'){
			die('threebase: data[\'key\'] is not a string', key);
		} 
		if (!objectInfoForKey[key]){
			die('threebase: no object found for data[\'key\']', key);
		}
		if (position){
			if (position.x === undefined || position.y === undefined || position.z === undefined){
				die('threebase: data[\'position\'] is not an x,y,z triple', position);
			} 
		}
		if (rotation){
			if (rotation.x === undefined || rotation.y === undefined || rotation.z === undefined){
				die('threebase: data[\'rotation\'] is not an x,y,z triple', rotation);
			} 
		} 
	}

	function die(message){
		throw new Error(message);
	}

	return {
    /**
     * Initialize the threebase module
     * @static
     * @method
     * @param {Firebase} syncInstance Firebase sync instance. Typically 
     *  obtained from altspace.utilities.sync.getInstance()
     * @param {Object} [params] Optional parameters.
     * @param {Boolean} [params.TRACE=false] Log debug messages.
     */
		init: init,
    /**
     * Add an object to be synced.
     * @static
     * @method
     * @param {THREE.Object3D} object The object to be synced. The object must
     *  have a unique name.
     * @param {Object} [params] Optional parameters.
     * @param {Boolean} [params.position=true] Sync the object's position.
     * @param {Boolean} [params.rotation=true] Sync the object's rotation.
     * @param {Number} [params.autoSyncEvery=100] Number of milliseconds 
     *  to wait between syncs.
     */
		add: add,
    /**
     * Manually save an object's state
     * @static
     * @method
     * @param {THREE.Object3D} object The object to be saved. The object must
     *  be added to threebase first.
     */
		save: save,
    /**
     * Update the state of the synced objects. Typically called in the render
     * loop.
     * @static
     * @method
     */
		update: update,
	};


}());
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Mon Oct 05 2015 04:07:53 GMT-0400 (Eastern Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
