<!--
	Author: Gavan Wilhite
	Copyright (c) 2015 Altspace VR
-->
<!DOCTYPE html>
<html lang="en">
<head>

	<title>Hats</title>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/1.1.0/shim.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script src="https://cdn.firebase.com/js/client/2.2.9/firebase.js"></script>

	<script src="http://sdk.altvr.com/libs/three.js/r71/build/three.min.js"></script>
	<script src="http://sdk.altvr.com/libs/three.js/r71/examples/js/loaders/MTLLoader.js"></script>
	<script src="http://sdk.altvr.com/libs/three.js/r71/examples/js/loaders/OBJMTLLoader.js"></script>

	<script src="../utilities/FirebaseSync.js"></script>

	<style>
		body {
			background-color: rgba(0, 0, 0, 0);
			margin: 0px;
			overflow: hidden;
		}
	</style>

</head>
<body>
<script>
if (!window.altspace) document.write('<h3>To view this example, please open this page in <a href="http://altvr.com"> AltspaceVR </a></h3>');

var Hats = (function () {
	var exports = {};

	var scene = new THREE.Scene();
	var renderer = altspace.getThreeJSRenderer({version:'0.2.0'});
	var objMtlLoader = new THREE.OBJMTLLoader();

	var localUser;
	var skeleton;
	var enclosure;

	var centerEye;

	var hats = {};

	//The entry point for our app. Errors in Promises can sometimes be confusing to read, so we explicity catch and print them.
	function init(){
		load().catch(function(error){
			console.error('Loading failed');
			console.dir(error.stack);//Printing the stack seems to be the best way to log the error to the inspector.
		}).then(start).catch(function(error){
			console.error('Startup failed');
			console.error(error.stack);
		});
	}

	//Load returns a promise that will resolve when all loading functions have completed.
	function load(){
		//Promise.all creates a new promise that resolves when all its child promises resolve. It returns an array of all the values returned from the child promises.
		//This is recomended when dealing with multiple asyncronous APIs, as we essentially get loading them all out of the way before starting our app.
		return Promise.all([loadModels(), altspace.getUser(), altspace.getThreeJSTrackingSkeleton(), altspace.getEnclosure(), /*connect(),*/ ]).then(function(values){
        	localUser = values[1];
        	skeleton = values[2];
        	enclosure = values[3];
        });
	}

	//LoadModels returns a promise that will resolve when all models have been loaded and stored.
	//This function is a pretty general, so feel free to copy it into your app and create other loadHat style functions.
	function loadModels(){

		//Changes the OBJMTL load function from a callback based API to a promise based one.
		function loadObjMtl(objUrl, mtlUrl){
			mtlUrl = mtlUrl || objUrl.slice(0, -4) + '.mtl';//Allows you to pass in only the obj url and have the mtl url assumed from the filename.
			return new Promise(function(resolve,reject){
				var progress = function(){};//Insert any per-file progress logic here.
				objMtlLoader.load(objUrl, mtlUrl, resolve, progress, reject);
			});
		}

		//Load and store a specific type of asset. This makes it easy assign an asset name to the loaded asset after loading completion.
		function loadHat(name, objMtlName){
			var baseUrl = 'models/hats/';
			return loadObjMtl(baseUrl + objMtlName).then(function(value){
				hats[name] = value;
			});
		}

		return Promise.all([
			loadHat('hard', 'hardhat.obj'),
			loadHat('red', 'redhat.obj'),
			loadHat('lava', 'LavaHelmet.obj'),
			loadHat('wizard', 'wizardhat.obj'),
			loadHat('straw', 'strawhat.obj'),
			loadHat('top', 'tophat.obj')
		]);
	}

    function connect() {
        var firebaseRootUrl = "https://altspace-apps.firebaseio.com/";
        var appId = "laser-tag";

        var params = { authTokenPath: "token.txt" };

        self.firebase = new FirebaseSync( firebaseRootUrl, appId, params );

        return new Promise(function(resolve,reject){
            self.firebase.connect( resolve, syncedObjectAdded, syncedObjectRemoved );
        });
    }

	function start(){
		console.log('start');
		console.dir(localUser);
		console.dir(skeleton);
		console.dir(enclosure);
		console.dir(hats);

    	scene.add(skeleton);//Important! Joints will not update otherwise.
		centerEye = skeleton.getJoint('Eye');//'Center' is a default paramater

		createHatMenu();

		update();
	}

	function createHatMenu(){
		var hatGap = 200;

		var hatValues = _.values(hats);

		for(var i = 0, max = hatValues.length; i < max; i++){
			var hat = hatValues[i].clone();
			scene.add(hat);
			hat.position.x = hatGap * i - hatGap * max / 2;

			hat.addEventListener('cursorup', function(e){
				if(localHat){
					centerEye.remove(localHat);
				}
				localHat = hat.clone();//TODO store and clear
				centerEye.add(localHat);
			});
			hat.scale.multiplyScalar(5);
			//hat.scale.multiplyScalar(500 / enclosure.pixelsPerMeter);
		}
	}

	function update() {
		requestAnimationFrame(update);
		renderer.render(scene);
	}

	init();

	exports.scene = scene;
	exports.hats = hats;
	return exports;
}());

</script>
</body>
</html>



