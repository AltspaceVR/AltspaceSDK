<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>Solar System Example</title>
<script src="http://sdk.altvr.com/libs/three.js/r73/build/three.js"></script>
<script src="http://sdk.altvr.com/libs/three.js/r73/examples/js/loaders/OBJMTLLoader.js"></script>
<script src="http://sdk.altvr.com/libs/three.js/r73/examples/js/loaders/MTLLoader.js"></script>
<script src="http://sdk.altvr.com/libs/altspace.js/latest/altspace.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>

<script src="http://sdk.altvr.com/utilities/0.5.2/multiloader.js"></script>
<script src="http://sdk.altvr.com/utilities/0.5.2/shims/cursor.js"></script>
<script src="http://sdk.altvr.com/utilities/0.5.2/shims/dualRenderer.js"></script>



<style>
	body {
		font-family: Monospace;
		color: #fff;
		margin: 0px;
		overflow: hidden;
	}
	#test-frame{
		position: absolute;
		left: 50%;
		top: 50%;
		margin-top: -250px;
		margin-left: -250px;
		width: 500px;
		height: 500px;
		border-radius: 500px;
		background-color: rgba(1, 0, 0, 0);
		box-shadow: 0 0 8px 600px rgba(0, 0, 0, 1);
	}
	#planet-list{
		font-size: 40px;
		left: -300px;
		position: absolute;
	}
</style>
</head>
<body>
	<div id="test-frame">
		<ul id="planet-list">
		</ul>
	</div>	
</body>
<script>

SolarSystemApp = (function(){

	var CONFIG = [
		// name, radius, distance, orbitalPeriod
		['sun',	     30,   0,   1],
		['mercury',	 2.4,  2,   0.2409],
		['venus',    6,    3,   0.616],
		['earth',    6.3,  4,   1],
		['mars',     3.3,  5,   1.9],
		['jupiter',	 14,   8,   12.0],
		['saturn',	 12,   10,  29.5],
		['uranus', 	 10,   12,  84],
		['neptune',  8,    14,  165],
	];
	var radiusCoeff = 0.022;
	var distanceCoeff = 9;
	var velocityCoeff = 0.005;

	var scene = new THREE.Scene();
	var planets = [];
	var planetsByName = {};
	var compactMode;
	var selectedPlanetName = 'earth';
	var solarSystem = new THREE.Object3D();
	var dualRenderer = altspace.utilities.shims.dualRenderer;
	var multiloader = altspace.utilities.multiloader;
	var loadRequest;
	var inAltMode;

	function main() {
		dualRenderer.init(scene);
		inAltMode = dualRenderer.inAltMode;
		compactMode = !inAltMode || window.innerHeight < 800;
		if (!inAltMode) {
			var camera = dualRenderer.camera;
		  altspace.utilities.shims.cursor.init(scene, camera);
			camera.position.z = 100;
			camera.position.y = 25;
			camera.lookAt( scene.position );
		}
		compactMode ? solarSystem.scale.set(5, 5, 5) : solarSystem.scale.set(5, 5, 5);
		scene.add(solarSystem);
		loadModels();
	}

	function loadModels(){// Load up the models
		multiloader.init({
			crossOrigin: 'anonymous',
			baseUrl: 'models/solar-system/'
			//hosted: 'http://sdk.altvr.com/examples/models/share/solar-system/'
		});
		loadRequest = new multiloader.LoadRequest();
		for (var i=0; i < CONFIG.length; i++) {
			var name = CONFIG[i][0];
			var planetElement = $("#planet-list").append('<li><span>' + name + '</span></li>')[0];
			$(planetElement).click(function(el){
				selectedPlanetName = el.target.innerHTML;
			});
			loadRequest.objUrls.push(name+'.obj');
			loadRequest.mtlUrls.push(name+'.mtl');
		}
		multiloader.load(loadRequest, initPlanets);
	}

	function initPlanets(){//Callback to be sure all models are loaded.
		for (var i=0; i < loadRequest.objects.length; i++) {
			var p = CONFIG[i];//guaranteed to be in same order
			var name = p[0];
			var radius = p[1];
			var distance = p[2];
			var orbitalPeriod = p[3];

			var obj = loadRequest.objects[i];
			planetsByName[name] = obj;
			obj.solarDistance = distance * distanceCoeff;
			obj.position.y = 10;
			obj.orbitalPosition = Math.random() * 3.14;
			obj.orbitalVelocity = (1 / orbitalPeriod) * velocityCoeff;
			obj.name = name;
			obj.scale.x = radius * radiusCoeff;
			obj.scale.y = radius * radiusCoeff;
			obj.scale.z = radius * radiusCoeff;
			obj.userData.originalScale = {};
			obj.userData.originalScale.x = obj.scale.x;
			obj.userData.originalScale.y = obj.scale.y;
			obj.userData.originalScale.z = obj.scale.z;

			planets.push(obj);
			solarSystem.add(obj);
		}
		animate();
	}

	function update(){
		for(var i = 0, max = planets.length; i < max; i++){
			var obj = planets[i];
			if(compactMode){
				if(obj === planetsByName[selectedPlanetName]) {
				 	obj.visible = true;
					obj.position.x = 0;
					obj.position.y = 0;
					obj.position.z = 0;
					var scale = inAltMode ? 3.6 : 0.4 ;//We should be calculating the bounding box and matching it up to the innerWidth and innerHeight
					obj.scale.x = scale;
					obj.scale.y = scale;
					obj.scale.z = scale;
				} else {
				 	obj.visible = false;
					obj.scale.x = 0;
					obj.scale.y = 0;
					obj.scale.z = 0;
				}
			} else {
				obj.orbitalPosition += obj.orbitalVelocity;
				var r = obj.solarDistance;
				var x = r*Math.sin(obj.orbitalPosition);
				var z = r*Math.cos(obj.orbitalPosition);
				obj.position.x = x;
				obj.position.z = z;
			}
			obj.rotation.y += 0.001;
		}
	}

	window.addEventListener('resize', function(){
		if(compactMode){
			document.getElementById('test-frame').style.visibility = 'visible';
		} else {
			document.getElementById('test-frame').style.visibility= 'hidden';
			for(var i = 0, max = planets.length; i < max; i++){
				var obj = planets[i];
				obj.scale.x = obj.userData.originalScale.x;
				obj.scale.y = obj.userData.originalScale.y;
				obj.scale.z = obj.userData.originalScale.z;
			}
		}
	});

	// Update & Rendering
	function animate() {
		requestAnimationFrame(animate);
		SolarSystemApp.update();
		dualRenderer.render();
	}

	return {
		main: main,
		update: update,
	}

}());

SolarSystemApp.main();

</script>
</html>