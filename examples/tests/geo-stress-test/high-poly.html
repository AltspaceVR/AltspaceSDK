<!DOCTYPE html>
<html>
    <head>
        <title>Geometry Stress Test</title>
        <script src="https://cdn.rawgit.com/mrdoob/three.js/r84/build/three.js"></script>
        <script src="https://cdn.rawgit.com/mrdoob/three.js/r84/examples/js/loaders/GLTFLoader.js"></script>
        <script src="https://cdn.rawgit.com/mrdoob/stats.js/066cb4e8/build/stats.min.js"></script>
        <script src="../../../dist/altspace.min.js"></script>
    </head>
    <body>
        <script>

            function LoaderPromise(url){
            	return new Promise(function(resolve, reject){
            		var loader = new THREE.GLTFLoader();
            		loader.setCrossOrigin('anonymous');
            		loader.load(url,
            			function(result){
            				var model = result.scene.children[0];
            				model.matrixAutoUpdate = true;
            				resolve(model);
            			},
            			undefined,
            			function(err){
            				reject(err);
            			}
            		);
            	});
            }

            var stats = new Stats();
            stats.showPanel(0);
            document.body.appendChild(stats.dom);

            var scene = new THREE.Scene();
            var renderer = altspace.getThreeJSRenderer();

            window.requestAnimationFrame(function animate(timestamp){
                window.requestAnimationFrame(animate);
                stats.begin();
                renderer.render(scene);
                stats.end();
            });

            function randPos(){
                return Math.random() * 3 - 1.5;
            }

            var modelPromise = new LoaderPromise('model.gltf')
            Promise.all([altspace.getEnclosure(), modelPromise])
            .then(function(results)
            {
                var enc = results[0];
                scene.scale.setScalar(enc.pixelsPerMeter);

                window.model = results[1];
                model.scale.setScalar(0.1);
                for(var i=0; i<5000; i++){
                    var s = model.clone();
                    s.children[0].children[0].material = new THREE.MeshBasicMaterial({color: Math.random() * 0xffffff});
                    s.position.set(randPos(), randPos(), randPos());
                    scene.add(s);
                }
            })
            .catch(function(err){
                console.error(err);
            });


        </script>
    </body>
</html>
