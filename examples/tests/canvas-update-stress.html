<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Canvas Update Stress Test</title>
		<meta charset="utf-8">
		<!--
		-->
		<script src="../../../UnityClient/js/src/AltGeoMatSerializer.js"></script>
		<script src="https://cdn.rawgit.com/mrdoob/three.js/r74/build/three.min.js"></script>
		<script src="https://cdn.rawgit.com/mrdoob/three.js/r74/examples/js/controls/OrbitControls.js"></script>
		<script src="https://cdn.rawgit.com/mrdoob/stats.js/r16/build/stats.min.js"></script>
		<script src="../../dist/altspace.js"></script>
	</head>
	<body>
		<button id="toggle">toggle</button>
		<span id="now" style="font: 85px sans-serif; color: red; position: absolute; right: 0; top: 3em;"></span>
		<script>
			var sim = new altspace.utilities.Simulation({auto: false, rendererOptions: {profile: true}}), controls, stats;

			if (!altspace.inClient) {
				controls = new THREE.OrbitControls(sim.camera);
			}

			var textureSize = 256;//Math.pow(2, 8);
			console.info('textureSize: ', textureSize, textureSize * textureSize * 4);
			var boxSize = 350;
			var box = new THREE.BoxGeometry(boxSize, boxSize, boxSize * 2);
			function createBox () {
				var canvas = document.createElement('canvas');
				canvas.width = textureSize;
				canvas.height = textureSize;
				var context = canvas.getContext('2d');
				context.font = "25px sans-serif";
				context.textBaseline = "top";
				var texture = new THREE.CanvasTexture(canvas);
				var material = new THREE.MeshBasicMaterial({ map: texture });

				var mesh = new THREE.Mesh(box, material);
				sim.scene.add(mesh);
				return {context: context, texture: texture, canvas: canvas};
			}
			
			var box = createBox();

			stats = new Stats();
			stats.showPanel(0);
			stats.domElement.style.zoom = '6';
			document.body.appendChild(stats.domElement);

			var n = 2;
			var w = textureSize / n;

			var canvases = [];
			for (var i = 0; i < 1; i++) {
				var canvas = document.createElement('canvas');
				canvas.width = textureSize;
				canvas.height = textureSize;
				var contextOne = canvas.getContext('2d');
				for(var x = 0; x < n; x++) {
					for(var y = 0; y < n; y++) {
						contextOne.fillStyle = 'hsl(' + (128) + ', 100%, 50%)';
						contextOne.fillRect(x * w , y * w, w, w);
					}
				}
				canvases.push(canvas);
			}

			box.context.fillStyle = 'black';

			var doAnimate = true;
			var i = 0;
			function animate() {
				if (doAnimate) {
					i += 1;
					box.context.drawImage(canvases[i % canvases.length], 0, 0);
					var dnow = Date.now();
					box.context.fillText(dnow, 0, 0);
					box.texture.needsUpdate = true;
					now.textContent = dnow;
				}

				if (controls) { 
					controls.update();
				}
				sim.renderer.render(sim.scene, sim.camera);

				stats.update();
			}
			setInterval(animate, 33);

			toggle.addEventListener('click', function () {
				doAnimate = !doAnimate;
			});
		</script>
	</body>
</html>
