<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>Spinning Cube</title>
<script src="http://sdk.altvr.com/libs/three.js/r71/build/three.min.js"></script>
<script src="http://sdk.altvr.com/libs/three.js/r71/examples/js/loaders/MTLLoader.js"></script>
<script src="http://sdk.altvr.com/libs/altspace.js/latest/altspace.min.js"></script>

<script src="http://localhost:8000/utilities/shims/cursor.js"></script>
<script src="http://localhost:8000/utilities/shims/dualRenderer.js"></script>

</head>
<body>
</body>
<script>

// Setup
var dualRenderer = altspace.utilities.dualRenderer;
dualRenderer.init();
if (dualRenderer.getCamera()) {//no camera if in Altspace
	dualRenderer.getCamera().position.z = 500; // stand back from origin
}

// Use MTLLoader for loadTexture, to ensure image is power of 2
// else antialiasing won't work (this is a limitation of WebGL)
var materialCreator = new THREE.MTLLoader.MaterialCreator();
materialCreator.crossOrigin = 'anonymous';
var url = 'https://sdk.altvr.com/examples/models/share/cube/altspace-logo.jpg';
var texture = materialCreator.loadTexture(url);

// Cube
var geometry = new THREE.BoxGeometry(1, 1, 1);
var material = new THREE.MeshBasicMaterial({color:'#ffffff', map: texture});
var cube = new THREE.Mesh(geometry, material);
cube.scale.multiplyScalar(100);
dualRenderer.getScene().add(cube);

// Sync
var ascp = altspace.utilities.codePen;
ascp.setName('Hello Cube'); 
var inCodePen = !!location.href.match('codepen.io/');
var params = inCodePen ? {
	instanceId: ascp.getPenId(),
	authorId: ascp.getAuthorId()
} : null;
var syncInstance = altspace.utilities.sync.getInstance(params);
var syncColor = syncInstance.child('color');
syncColor.on('value', function(snapshot){
	var val = snapshot.val();
	if (val) {
		cube.material.color = new THREE.Color(val);
	}
});

// Events
cube.addEventListener('cursordown', function() {
	syncColor.set(Please.make_color()[0]); // clicking on cube changes its color
});

// Update & Rendering
function animate() {
	cube.rotation.y += 0.01; // rotation is not synchronized
	requestAnimationFrame(animate);
	dualRenderer.render();
}
animate();

</script>
</html>