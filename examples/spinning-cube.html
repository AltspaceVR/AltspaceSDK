<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>Spinning Cube</title>
<script src="https://sdk.altvr.com/libs/three.js/r71/build/three.min.js"></script>
<script src="https://sdk.altvr.com/libs/three.js/r71/examples/js/loaders/MTLLoader.js"></script>
<script src="https://sdk.altvr.com/libs/altspace.js/latest/altspace.min.js"></script>
<script src="https://sdk.altvr.com/utilities/shims/CursorEvents.js"></script>

</head>
<body>
<script>


var ascp = altspace.utilities.codePen;
ascp.setName("Hello Cube"); 
var inCodePen = !!ascp.getPenId().match(/[0-9][a-f].*/);
var inAltspace = window.altspace && window.altspace.inClient;

// Setup
var renderer, camera, cursorEvents;
var scene = new THREE.Scene();
if ( inAltspace ) {
	renderer = altspace.getThreeJSRenderer({version:'0.2.0'});
} else {
	renderer = new THREE.WebGLRenderer();
	camera = new THREE.PerspectiveCamera();
	initScene( scene, renderer, camera );
	cursorEvents = new CursorEvents( scene, camera );
	camera.position.z = 500; // stand back from origin
}

// Use MTLLoader for loadTexture, to ensure image is power of 2
// else antialiasing won't work (this is a limitation of WebGL)
var materialCreator = new THREE.MTLLoader.MaterialCreator();
materialCreator.crossOrigin = "anonymous";
var url = 'https://sdk.altvr.com/examples/models/AltspaceCube/altspace-logo.jpg';
var texture = materialCreator.loadTexture(url);

// Cube
var geometry = new THREE.BoxGeometry(1, 1, 1);
var material = new THREE.MeshBasicMaterial({color:'#ffffff', map: texture});
var cube = new THREE.Mesh(geometry, material);
cube.scale.multiplyScalar(100);
if (inAltspace) cube.position.y = -450; // set on ground
scene.add(cube);

// Sync
var params = inCodePen ? {instanceId: ascp.getPenId(), authorId: ascp.getAuthorId()} : null;
var syncInstance = altspace.utilities.sync.getInstance(params);
var syncColor = syncInstance.child('color');
syncColor.on('value', function(snapshot){
	var val = snapshot.val();
	if ( val ) {
		cube.material.color = new THREE.Color(val);
		// TODO: Remove when altspace renderer no longer requires this flag.
		if ( inAltspace ) cube.material.needsUpdate = true;
	}
});

// Events
cube.addEventListener('cursordown', function() {
	syncColor.set(Please.make_color()[0]); // clicking on cube changes its color
});

// Update & Rendering
function animate() {
	cube.rotation.y += 0.01; // rotation is not synchronized
	requestAnimationFrame(animate);
	renderer.render(scene, camera);
}
animate();


function initScene( myScene, myRenderer, myCamera ) {
	myRenderer.antialias = true;
	myRenderer.setClearColor("#AAAAAA");
	myRenderer.setSize(window.innerWidth, window.innerHeight);
	document.body.appendChild(myRenderer.domElement);
	myCamera.fov = 45;
	myCamera.aspect = window.innerWidth / window.innerHeight;
	myCamera.near = 1;
	myCamera.far = 2000;
	myScene.add(myCamera);
	window.addEventListener('resize', function(event) {
		myCamera.aspect = window.innerWidth / window.innerHeight;
		myCamera.updateProjectionMatrix();
		myRenderer.setSize(window.innerWidth, window.innerHeight);
	});
}

</script>
</body>
</html>