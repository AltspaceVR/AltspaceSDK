<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Renderer Tests</title>
		<meta charset="utf-8">
		<style>
			body {
				margin: 0px;
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.js"></script>
		<script src="../lib/MTLLoader.js"></script>
		<script src="../lib/OBJMTLLoader.js"></script>
		<script src="../src/cursor/CursorEvents.js"></script>
		<script src="../src/cursor/AltObjectControls.js"></script>

		<!--<script src="../../UnityClient/js/src/AltRenderer.js"></script>
		<script src="../../UnityClient/js/src/AltGeoMatSerializer.js"></script>-->

		<script>

			var scene, renderer, camera, cursorEvents;
			var 
				tintTexCube, colorTexCube, tintColorCube, 
				animatedCube, colorCube, texturedCube, 
				tintedObj, visibilityCube, matVisibilityCube;

			init();
			animate();

			var textureMat;

			function addTexturedCube () {
				var geometry = new THREE.BoxGeometry( 25, 25, 25 );

				if (!textureMat) {
					var texture = THREE.ImageUtils.loadTexture(
						'textures/UV_Grid_Sm.jpg' );
					textureMat = new THREE.MeshBasicMaterial( { map: texture } );
				}

				var tCube = new THREE.Mesh( geometry, textureMat );
				// RIGHT
				tCube.position.set(50, 0, 0);
				scene.add( tCube );
				return tCube;
			}

			function addColorCube (color) {
				color = color || 'red';
				var geometry = new THREE.BoxGeometry( 25, 25, 25 );
				var cCube = new THREE.Mesh(
					geometry,
					new THREE.MeshBasicMaterial({color: color}) );
				// LEFT
				cCube.position.set(-50, 0, 0);
				scene.add( cCube );
				return cCube;
			}
			
			function deepTint (obj, tintColor) {
				obj.userData.tintColor = tintColor;
				for (var i = 0; i < obj.children.length; i++) {
					obj.children[i].userData.tintColor = tintColor;
				}
			}

			function init() {
				scene = new THREE.Scene();
				scene.position.set(0, -60, 0);
				scene.scale.multiplyScalar(2);

				if (window.altspace) {
					renderer = altspace.getThreeJSRenderer({version: '0.2.0'});
				}
				else {
					renderer = new THREE.WebGLRenderer();
					renderer.setClearColor("#AAAAAA");
					renderer.setSize( window.innerWidth, window.innerHeight );
					document.body.appendChild( renderer.domElement );
					renderer.setSize( window.innerWidth, window.innerHeight );
					var aspect = window.innerWidth / window.innerHeight;
					camera = new THREE.PerspectiveCamera(45, aspect, 1, 2000 );
					camera.position.z = 400;
					camera.position.y = 50;
					camera.lookAt( scene.position );
					var ambient = new THREE.AmbientLight( 0xffffff );
					scene.add( ambient );
					cursorEvents = new CursorEvents( scene );
					cursorEvents.enableMouseEvents( camera );
				}

				// TOP
				tintTexCube = addTexturedCube();
				tintTexCube.position.set(0, 50, 0);
				tintTexCube.userData.tintColor = {r: 1, g: 0, b: 0};

				// BOTTOM
				colorTexCube = addTexturedCube();
				colorTexCube.position.set(0, -50, 0);
				colorTexCube.material = colorTexCube.material.clone()
				colorTexCube.material.color.setHSL(0.25, 1, 0.5);

				// TOP LEFT
				tintColorCube = addColorCube('cyan');
				tintColorCube.position.set(-50, 50, 0);

				// CENTER
				animatedCube = addTexturedCube();
				animatedCube.position.set(0, 0, 0);

				// TOP RIGHT
				visibilityCube = addColorCube('blue');
				visibilityCube.position.set(50, 50, 0);
				var visInnerCube = addColorCube('blue');
				visInnerCube.position.set(50, 50, 0);
				visInnerCube.scale.multiplyScalar(0.5);
				visInnerCube.addEventListener('cursordown', function () {
					this.material.color.setHex(0xff0000);
				});
				visInnerCube.addEventListener('cursorup', function () {
					this.material.color.setHex(0x00ff00);
				});
				if (!window.altspace) {
					cursorEvents.addObject(visInnerCube);
				}

				// BOTTOM RIGHT
				matVisibilityCube = addTexturedCube();
				matVisibilityCube.material = matVisibilityCube.material.clone()
				matVisibilityCube.name = 'matVisibilityCube';
				matVisibilityCube.position.set(50, -50, 0);
				var matVisInnerCube = addColorCube('blue');
				matVisInnerCube.position.set(80, -50, 0);
				matVisInnerCube.scale.multiplyScalar(0.5);
				matVisibilityCube.addEventListener('cursordown', function () {
					matVisInnerCube.material.color.setHex(0xff0000);
				});
				matVisibilityCube.addEventListener('cursorup', function () {
					matVisInnerCube.material.color.setHex(0x00ff00);
				});
				if (!window.altspace) {
					cursorEvents.addObject(matVisibilityCube);
				}


				var loader = new THREE.OBJMTLLoader();
				var objFilename = "models/AltspaceCube/cube.obj";
				var mtlFilename = "models/AltspaceCube/cube.mtl";
				loader.load(
					objFilename,
					mtlFilename,
					function ( loadedObject ) {
						// BOTTOM LEFT
						tintedObj = loadedObject;
						tintedObj.scale.multiplyScalar(2.5);
						tintedObj.position.set(-50, -50, 0);
						scene.add(tintedObj);
					}
				);

			}

			var lastTick = Date.now();
			var tick = true;
			var i = 0;
			function animate() {

				requestAnimationFrame( animate );

				if (Date.now() - lastTick > 1000) {
					if (tick) {
						texturedCube = addTexturedCube();
						scene.remove(colorCube);
						var green = {r: 0, g: 1, b: 0};
						tintColorCube.userData.tintColor = green;
						tintTexCube.userData.tintColor = green;
						colorTexCube.material.color.setHex(0x00ff00);
						deepTint(tintedObj, green);
						visibilityCube.visible = true;
						matVisibilityCube.material.visible = true;
					}
					else {
						scene.remove(texturedCube);
						colorCube = addColorCube();
						var blue = {r: 0, g: 0, b: 1};
						tintColorCube.userData.tintColor = undefined;
						tintTexCube.userData.tintColor = blue;
						colorTexCube.material.color.setHex(0x0000ff);
						deepTint(tintedObj, blue);
						visibilityCube.visible = false;
						matVisibilityCube.material.visible = false;
					}
					tick = !tick;
					lastTick = Date.now();
				}

				i += 0.01;
				animatedCube.rotation.x = Math.sin(i);
				animatedCube.rotation.y = Math.cos(i);
				animatedCube.position.z = Math.sin(i) * 25;

				if (cursorEvents) { 
					cursorEvents.update();
				}

				renderer.render( scene, camera );

			}

		</script>

	</body>
</html>
